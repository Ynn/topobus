<!DOCTYPE html>
<html lang="en" class="theme-latte">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TopoBus</title>
    <meta name="description" content="KNX topology explorer for .knxproj files.">
    <meta name="theme-color" content="#0f766e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TopoBus">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="topobus-logo.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="topobus-icon-180.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="classic.css">
    <link rel="stylesheet" href="styles.css">
    
    <!-- JointJS dependencies -->
    <script src="vendor/jquery.min.js"></script>
    <script src="vendor/lodash.min.js"></script>
    <script src="vendor/backbone-min.js"></script>
    <script src="vendor/joint.min.js"></script>
    <link rel="stylesheet" href="vendor/joint.min.css">
    <!-- ELK layout -->
    <script src="vendor/elk.bundled.js"></script>
</head>

<body class="theme-latte">
    <!-- Overlay for Upload (Drag & Drop) -->
    <div id="upload-zone" class="upload-zone hidden">
        <div class="upload-content">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <h2>Drop your .knxproj file</h2>
            <p>or <label for="file-input" class="file-label">browse your computer</label></p>
            <input type="file" id="file-input" accept=".knxproj" style="display: none;">
            <div class="password-row hidden" id="password-row">
                <form id="password-form" novalidate>
                    <label for="password-input">Project password (Decryption is local; no password is sent over the network.)</label>
                    <div class="password-actions">
                        <input type="password" id="password-input" placeholder="Leave blank if none" autocomplete="new-password">
                        <button type="button" id="password-submit">Retry</button>
                    </div>
                    <div class="password-hint" id="password-hint"></div>
                </form>
            </div>
        </div>
    </div>

    <div class="window" id="app-window">
        <!-- Top Tabs Bar (Views) -->
        <div class="tabs-bar">
            <div class="brand">
                <img src="topobus-logo.svg" alt="TopoBus logo" class="brand-logo">
                <span class="app-logo">TopoBus</span>
                <span class="title-text" id="project-title">No Project Loaded</span>
            </div>
            <div id="view-tabs" class="tab-container" style="display: flex;">
                <div class="tab" id="btn-open-project">üìÇ Open</div>
                <div class="tab active" data-view-type="group">üè† Group Addresses</div>
                <div class="tab" data-view-type="topology">üåø Topology</div>
                <div class="tab" data-view-type="buildings">üè¢ Buildings</div>
                <div class="tab" data-view-type="devices">üîå Devices</div>
            </div>
            <div class="search-container" style="margin-left: auto; margin-right: 16px;">
                <button class="icon-btn settings-btn update-btn" id="refresh-btn" title="Reload">‚Üª</button>
                <button class="icon-btn settings-btn" id="help-btn" title="Help">?</button>
                <button class="icon-btn settings-btn" id="settings-btn" title="Settings">‚öô</button>
                <input type="text" id="search-input" class="search-input" placeholder="Search... (Ctrl+F)" autocomplete="off">
                <button class="search-clear">√ó</button>
            </div>
        </div>

        <!-- Update toast (shown when a new SW version is available) -->
        <div id="update-toast" class="update-toast hidden" role="status" aria-live="polite">
            <div class="update-toast__text">
                New version available
            </div>
            <div class="update-toast__actions">
                <button type="button" class="update-toast__btn" id="update-toast-reload">Reload</button>
                <button type="button" class="update-toast__close" id="update-toast-close" aria-label="Close">‚úï</button>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Sidebar -->
            <div class="sidebar" id="left-sidebar">
                <div class="sidebar-header" id="sidebar-title">
                    <span id="sidebar-title-text">Explore</span>
                    <div class="sidebar-actions">
                        <button class="icon-btn" id="btn-expand-all" title="Expand all">‚ñæ</button>
                        <button class="icon-btn" id="btn-collapse-all" title="Collapse all">‚ñ∏</button>
                        <button class="panel-toggle-btn" id="toggle-sidebar-btn">‚óÄ</button>
                    </div>
                </div>
                <div class="tree" id="sidebar-tree">
                    <!-- Tree content will be injected here -->
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        No project loaded.
                    </div>
                </div>
            </div>
            <div class="resizer" id="left-resizer"></div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="content-tabs" id="center-tabs">
                    <div class="content-tab active" data-tab="table">üìã Table View</div>
                    <div class="content-tab" data-tab="graph">üï∏Ô∏è Graph View</div>
                    <div class="content-actions">
                        <button class="content-btn" id="btn-export-csv">‚¨á CSV</button>
                    </div>
                    <div class="graph-mode" id="graph-mode" style="display: none;">
                        <button class="graph-mode-btn active" data-mode="flat">Graph</button>
                        <button class="graph-mode-btn" data-mode="hierarchy">Hierarchy</button>
                    </div>
                </div>
                
                <div id="view-container" style="flex: 1; position: relative; overflow: hidden;">
                    <!-- Table View -->
                    <div id="table-view" class="table-container" style="height: 100%; overflow: auto;">
                        <table id="main-table">
                            <thead id="table-head">
                                <!-- Dynamic headers -->
                            </thead>
                            <tbody id="table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                        <div id="empty-table-state" style="padding: 40px; text-align: center; color: var(--text-muted); display: none;">
                            Select an item in the sidebar to view details.
                        </div>
                    </div>

                    <!-- Graph View (Topobus Original) -->
                    <div id="graph-view" style="display: none; height: 100%; width: 100%; position: relative;">
                         <div class="graph-toolbar" id="graph-toolbar">
                            <button class="toolbar-btn" id="btn-fit-view">üîç Fit</button>
                            <button class="toolbar-btn" id="btn-relayout">üîÑ Layout</button>
                            <button class="toolbar-btn" id="btn-export-svg">‚¨á SVG</button>
                            <button class="toolbar-btn" id="btn-graph-fullscreen">‚õ∂ Full Screen</button>
                            <button class="toolbar-btn" id="btn-graph-legend" title="Toggle legend">Legend</button>
                        </div>
                        <div class="graph-selection hidden" id="selection-banner" role="status" aria-live="polite">
                            <span id="selection-banner-text"></span>
                            <button type="button" class="selection-banner__close" id="selection-banner-close" aria-label="Clear selection">‚úï</button>
                        </div>
                        <div class="graph-legend hidden" id="graph-legend" title="Legend: group object semantic colors">
                            <span class="graph-legend-item"><span class="graph-legend-swatch st"></span>S+T</span>
                            <span class="graph-legend-item"><span class="graph-legend-swatch s"></span>S</span>
                            <span class="graph-legend-item"><span class="graph-legend-swatch noc"></span>not C</span>
                            <span class="graph-legend-item"><span class="graph-legend-swatch other"></span>other</span>
                        </div>
                        <!-- Loading Indicator (Graph View) -->
                        <div id="loading" class="hidden">
                            <div class="spinner"></div>
                            <p id="loading-message">Loading project...</p>
                        </div>
                         <div id="paper-container" style="width: 100%; height: 100%; overflow: hidden;">
                            <div id="paper-scroll" style="width: 100%; height: 100%; overflow: hidden;">
                                <div id="paper"></div>
                            </div>
                            <div id="minimap-wrap">
                                <div class="minimap-label">Minimap</div>
                                <canvas id="minimap"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resizer" id="right-resizer"></div>

            <!-- Properties Sidebar (Right) -->
            <div class="properties-sidebar" id="right-sidebar">
                <div class="properties-header">
                    <span>Info</span>
                    <button class="panel-toggle-btn" id="toggle-props-btn">‚ñ∂</button>
                </div>
                <div class="properties-tabs">
                    <div class="prop-tab active">
                        <span class="icon">‚ÑπÔ∏è</span>
                        <span>Info</span>
                    </div>
                </div>
                <div class="properties-content" id="properties-panel">
                    <div class="empty-state">Select an item to view properties.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Reopen Buttons -->
    <button class="panel-reopen-btn left" id="sidebar-reopen" style="display: none;" title="Show Sidebar">‚ñ∂</button>
    <button class="panel-reopen-btn right" id="properties-reopen" style="display: none;" title="Show Properties">‚óÄ</button>

    <!-- Settings Panel -->
    <div class="settings-overlay hidden" id="settings-overlay">
        <div class="settings-panel">
            <div class="settings-header">
                <span>Settings</span>
                <button class="icon-btn" id="settings-close">‚úï</button>
            </div>
            <div class="settings-body">
                <div class="settings-tabs" role="tablist" aria-label="Settings sections">
                    <button class="settings-tab active" type="button" role="tab" aria-selected="true" data-settings-tab="theme">Theme</button>
                    <button class="settings-tab" type="button" role="tab" aria-selected="false" data-settings-tab="layout">Layout</button>
                </div>
                <div class="settings-tab-panel active" role="tabpanel" data-settings-panel="theme">
                    <div class="settings-section">
                        <label class="settings-label" for="settings-theme">Theme</label>
                        <select id="settings-theme" class="settings-select">
                            <option value="classic">Classic</option>
                            <option value="latte">Latte</option>
                            <option value="mocha">Mocha</option>
                        </select>
                    </div>
                    <div class="settings-section">
                        <label class="settings-label" for="settings-product-language">Product language</label>
                        <select id="settings-product-language" class="settings-select">
                            <option value="en">English (EN)</option>
                            <option value="fr">French (FR)</option>
                            <option value="de">German (DE)</option>
                        </select>
                        <div class="settings-note">Used when translations are available. Fallback: EN ‚Üí FR ‚Üí DE ‚Üí other.</div>
                    </div>
                    <div class="settings-section">
                        <label class="settings-toggle">
                            <input type="checkbox" id="settings-show-all-ga-links" />
                            <span>Show all device relations per group address (may be slow on large projects)</span>
                        </label>
                    </div>
                </div>
                <div class="settings-tab-panel" role="tabpanel" data-settings-panel="layout">
                    <div class="settings-section">
                        <label class="settings-label" for="settings-elk-preset">Preset</label>
                        <select id="settings-elk-preset" class="settings-select">
                            <option value="fast">Fast</option>
                            <option value="balanced">Balanced</option>
                            <option value="quality">Quality</option>
                            <option value="stress">Stress</option>
                            <option value="custom">Custom</option>
                        </select>
                        <div class="settings-grid">
                            <div>
                            <label class="settings-label" for="settings-elk-algorithm">Algorithm</label>
                            <select id="settings-elk-algorithm" class="settings-select">
                                <option value="layered">layered</option>
                                <option value="force">force</option>
                                <option value="radial">radial</option>
                                <option value="mrtree">mrtree</option>
                                <option value="disco">disco</option>
                                <option value="stress">stress</option>
                            </select>
                        </div>
                            <div>
                                <label class="settings-label" for="settings-elk-direction">Direction</label>
                                <select id="settings-elk-direction" class="settings-select">
                                    <option value="RIGHT">RIGHT</option>
                                    <option value="DOWN">DOWN</option>
                                    <option value="LEFT">LEFT</option>
                                    <option value="UP">UP</option>
                                </select>
                            </div>
                            <div>
                                <label class="settings-label" for="settings-elk-edge-routing">Edge Routing</label>
                                <select id="settings-elk-edge-routing" class="settings-select">
                                    <option value="POLYLINE">POLYLINE</option>
                                    <option value="ORTHOGONAL">ORTHOGONAL</option>
                                    <option value="SPLINES">SPLINES</option>
                                </select>
                            </div>
                            <div>
                                <label class="settings-label" for="settings-elk-splines-mode">Splines Mode</label>
                                <select id="settings-elk-splines-mode" class="settings-select">
                                    <option value="CONSERVATIVE">CONSERVATIVE</option>
                                    <option value="SLOPPY">SLOPPY</option>
                                </select>
                            </div>
                        </div>
                        <details class="settings-advanced">
                            <summary>Advanced layout settings</summary>
                            <div class="settings-grid">
                                <div>
                                    <label class="settings-label" for="settings-elk-layering">Layering</label>
                                    <select id="settings-elk-layering" class="settings-select">
                                        <option value="NETWORK_SIMPLEX">NETWORK_SIMPLEX</option>
                                        <option value="LONGEST_PATH">LONGEST_PATH</option>
                                        <option value="INTERACTIVE">INTERACTIVE</option>
                                        <option value="COFFMAN_GRAHAM">COFFMAN_GRAHAM</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-elk-node-placement">Node Placement</label>
                                    <select id="settings-elk-node-placement" class="settings-select">
                                        <option value="BRANDES_KOEPF">BRANDES_KOEPF</option>
                                        <option value="LINEAR_SEGMENTS">LINEAR_SEGMENTS</option>
                                        <option value="NETWORK_SIMPLEX">NETWORK_SIMPLEX</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-elk-crossing">Crossing Minimization</label>
                                    <select id="settings-elk-crossing" class="settings-select">
                                        <option value="LAYER_SWEEP">LAYER_SWEEP</option>
                                        <option value="MEDIAN_LAYER_SWEEP">MEDIAN_LAYER_SWEEP</option>
                                        <option value="INTERACTIVE">INTERACTIVE</option>
                                        <option value="NONE">NONE</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-elk-cycle-breaking">Cycle Breaking</label>
                                    <select id="settings-elk-cycle-breaking" class="settings-select">
                                        <option value="GREEDY">GREEDY</option>
                                        <option value="MODEL_ORDER">MODEL_ORDER</option>
                                        <option value="GREEDY_MODEL_ORDER">GREEDY_MODEL_ORDER</option>
                                        <option value="INTERACTIVE">INTERACTIVE</option>
                                    </select>
                                </div>
                            </div>
                            <div class="settings-grid">
                                <div>
                                    <label class="settings-label" for="settings-elk-thoroughness">Thoroughness</label>
                                    <input id="settings-elk-thoroughness" class="settings-input" type="number" min="1" max="20" step="1">
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-elk-spacing-node">Spacing node-node</label>
                                    <input id="settings-elk-spacing-node" class="settings-input" type="number" min="10" step="5">
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-elk-spacing-layer">Spacing between layers</label>
                                    <input id="settings-elk-spacing-layer" class="settings-input" type="number" min="20" step="10">
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-elk-spacing-edge-node-layers">Edge-node between layers</label>
                                    <input id="settings-elk-spacing-edge-node-layers" class="settings-input" type="number" min="5" step="5">
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-elk-spacing-edge-edge-layers">Edge-edge between layers</label>
                                    <input id="settings-elk-spacing-edge-edge-layers" class="settings-input" type="number" min="5" step="5">
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-elk-spacing-edge-node">Edge-node spacing</label>
                                    <input id="settings-elk-spacing-edge-node" class="settings-input" type="number" min="5" step="5">
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-elk-spacing-edge-edge">Edge-edge spacing</label>
                                    <input id="settings-elk-spacing-edge-edge" class="settings-input" type="number" min="5" step="5">
                                </div>
                            </div>
                            <div class="settings-checkboxes">
                                <label class="settings-check"><input type="checkbox" id="settings-elk-consider-model"> Consider model order</label>
                                <label class="settings-check"><input type="checkbox" id="settings-elk-merge-edges"> Merge edges</label>
                            </div>
                        </details>
                        <details class="settings-advanced">
                            <summary>Stress layout settings</summary>
                            <div class="settings-grid">
                                <div>
                                    <label class="settings-label" for="settings-stress-iterations">Iterations</label>
                                    <input id="settings-stress-iterations" class="settings-input" type="number" min="50" step="10">
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-stress-epsilon">Epsilon</label>
                                    <input id="settings-stress-epsilon" class="settings-input" type="number" min="0.0001" step="0.0001">
                                </div>
                                <div>
                                    <label class="settings-label" for="settings-stress-edge-length">Desired edge length</label>
                                    <input id="settings-stress-edge-length" class="settings-input" type="number" min="20" step="5">
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                <div class="settings-actions">
                    <button class="settings-cancel-btn" id="settings-cancel">Cancel</button>
                    <button class="settings-save-btn" id="settings-save">Save</button>
                    <button class="settings-reset-btn" id="settings-reset">Reset to defaults</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Panel -->
    <div class="settings-overlay hidden" id="help-overlay">
        <div class="settings-panel">
            <div class="settings-header">
                <span>Help</span>
                <button class="icon-btn" id="help-close">‚úï</button>
            </div>
            <div class="settings-body">
                <div class="settings-tabs" role="tablist" aria-label="Help sections">
                    <button class="settings-tab active" type="button" role="tab" aria-selected="true" data-help-tab="help">Help</button>
                    <button class="settings-tab" type="button" role="tab" aria-selected="false" data-help-tab="about">About</button>
                </div>
                <div class="settings-tab-panel active" role="tabpanel" data-help-panel="help">
                    <div class="settings-section help-section">
                        <h3>Offline Progressive Web App</h3>
                        <div class="help-paragraph">
                            TopoBus runs entirely in your browser. Your project files are never uploaded.
                        </div>
                        <div class="help-paragraph">
                            On Chrome or Edge, TopoBus can be installed as a Progressive Web App (PWA) and used offline.
                            Learn more: <a href="https://en.wikipedia.org/wiki/Progressive_web_app" target="_blank" rel="noreferrer">Progressive web app</a>.
                        </div>
                    </div>
                    <div class="settings-section help-section">
                        <h3>Navigation Basics</h3>
                        <div class="help-list">
                            <div>Left click: move objects when dragging them.</div>
                            <div>Left drag on empty space: pan the view.</div>
                            <div>Middle button drag: pan without selecting.</div>
                            <div>Mouse wheel: zoom in/out (pinch on trackpad).</div>
                            <div>Right click on an element: open the context menu.</div>
                        </div>
                    </div>
                    <div class="settings-section help-section">
                        <h3>Quick Tips</h3>
                        <div class="help-paragraph">
                            Blue values are clickable shortcuts (addresses, areas, lines, devices).
                        </div>
                    </div>
                </div>
                <div class="settings-tab-panel" role="tabpanel" data-help-panel="about">
                    <div class="settings-section help-section">
                        <h3>About</h3>
                        <div class="help-paragraph">
                            <strong>This application is not affiliated with KNX Association. KNX is a registered trademark.</strong>
                        </div>
                        <div class="help-paragraph">
                            <strong>KNX Association owns KNX (the world's only open standard for Home and Building Control Systems)
                            and owns the KNX Logo, a worldwide registered trademark.</strong>
                        </div>
                        <div class="help-paragraph">
                            Source code: <a href="https://github.com/Ynn/topobus" target="_blank" rel="noreferrer">github.com/Ynn/topobus</a>.
                        </div>
                        <div class="help-paragraph">
                            License: AGPLv3. <a href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank" rel="noreferrer">Read the license</a>.
                        </div>
                        <div class="help-paragraph">
                            Open source libraries: JointJS (MPL 2.0) ‚Äî <a href="https://github.com/clientIO/joint/blob/master/LICENSE" target="_blank" rel="noreferrer">https://github.com/clientIO/joint</a>,
                            ELK (EPL 2.0) ‚Äî <a href="https://www.eclipse.org/elk/" target="_blank" rel="noreferrer">eclipse.org/elk</a>.
                        </div>
                        <div class="help-paragraph">
                            The Mocha and Latte themes are derived from <a href="https://catppuccin.com/" target="_blank" rel="noreferrer">Catppuccin</a>.
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script type="module" src="app.js"></script>
</body>

</html>
